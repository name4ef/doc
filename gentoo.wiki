=== install amd64  ===
https://mirror.yandex.ru/gentoo-distfiles/releases/amd64/autobuilds/current-install-amd64-minimal/install-amd64-minimal-<somedate>.iso
==== up network and run sshd ====
{{{sh
wpa_passphrase <SSID> >> /etc/wpa_supplicant.conf
wpa_supplicant -D wext -i wlp1s0 -c /etc/wpa_supplicant.conf -B
ntpd -q -g
/etc/init.d/sshd start
passwd # set password for root
}}}
==== basic action ====
 - create efi, swap and root partitions over cfdisk (gpt)
{{{sh
# WARNING: partitions of sda will be overwrited
mkfs.vfat /dev/sda1
mkswap /dev/sda2 && swapon /dev/sda2
mkfs.ext4 /dev/sda3 && mount /dev/sda3 /mnt/gentoo && cd /mnt/gentoo &&
links https://mirror.yandex.ru/gentoo-distfiles/releases/amd64/autobuilds/current-stage3-amd64/
# or links https://www.gentoo.org/downloads/mirrors/
#   select mirror
#   go to *releases/amd64/autobuilds/current-stage3-amd64* directory
}}}
- downloads:
    - *stage3-amd64-<YYYYMMDDTHHMMSSZ>.tar.xz*
    - *stage3-amd64-<YYYYMMDDTHHMMSSZ>.tar.xz.DIGESTS.asc*
{{{sh
grep $(openssl dgst -r -sha512 stage3-amd64-*.tar.xz) *.asc &&
tar xpf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner &&
cat << EOF >> etc/portage/make.conf &&
MAKEOPTS="-j4"
GENTOO_MIRRORS="http://mirror.yandex.ru/gentoo-distfiles/" # mirrorselect -i -o >> etc/portage/make.conf
EOF
mkdir etc/portage/repos.conf &&
cp usr/share/portage/config/repos.conf etc/portage/repos.conf/gentoo.conf &&
cp -L /etc/resolv.conf etc/ &&
mount -t proc /proc proc/ && mount -R /sys sys/ && mount -R /dev dev/ &&
chroot . /bin/bash
}}}
{{{sh
source /etc/profile && export PS1="(chroot) ${PS1}" &&
emerge-webrsync &&
emerge --verbose --update --deep --newuse @world &&
echo "Asia/Tomsk" > /etc/timezone && emerge --config sys-libs/timezone-data &&
emerge net-misc/ntp && ntpd -q -g &&
echo "export LANG='en_US.utf8'" >> /etc/profile.env &&
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen &&
locale-gen &&
eselect locale list
# TODO LC_ALL is empty, why?
}}}
 - eselect locale set 4 # (en_US.utf8)
{{{sh
# WARNING: check correctness partitions in fstab
env-update && source /etc/profile && export PS1="(chroot) ${PS1}" &&
emerge sys-kernel/gentoo-sources &&
emerge --ask sys-kernel/genkernel sys-kernel/linux-firmware &&
etc-update &&
emerge sys-kernel/genkernel sys-kernel/linux-firmware &&
genkernel all &&
cat << EOF >> /etc/fstab &&
/dev/sda1 /boot/efi vfat noauto  0 1
/dev/sda2 none      swap sw      0 0
/dev/sda3 /         ext4 noatime 0 1
EOF
echo -e "\nPlease set root password:" &&
passwd &&
emerge app-admin/sysklogd &&
rc-update add sysklogd default &&
rc-update add sshd default &&
rc-update add ntpd &&
emerge sys-fs/e2fsprogs net-misc/dhcpcd sys-apps/ethtool &&
emerge app-editors/vim dev-util/ctags app-misc/task dev-python/six dev-python/pip &&
emerge app-misc/tmux app-text/tree sys-process/htop dev-vcs/git
}}}
==== boot over lilo ====
 - emerge --ask sys-boot/lilo
 - liloconfig; vim /etc/lilo.conf; lilo
==== boot over grub (UEFI) ====
{{{sh
emerge sys-boot/grub:2 &&
mkdir /boot/efi && mount /boot/efi &&
echo 'GRUB_PLATFORMS="efi-64"' >> /etc/portage/make.conf &&
grub-install --target=x86_64-efi --efi-directory=/boot/efi &&
grub-mkconfig -o /boot/grub/grub.cfg &&
umount /boot/efi
}}}
==== configure wirelss network ====
 - emerge net-wireless/wpa_supplicant
 - wpa_passphrase <SSID> >> /etc/wpa_supplicant/wpa_supplicant.conf
 - vim /etc/conf.d/wpa_supplicant
    wpa_supplicant_args="-D wext -i wlp1s0 -c /etc/wpa_supplicant/wpa_supplicant.conf -B"
 - rc-update add wpa_supplicant # /etc/init.d/wpa_supplicant start
==== final steps ====
 - useradd -d /home/user1 -G users,wheel -m user1
 - passwd user1
 - vim /etc/{conf.d/hostname,hosts} # set hostname
 - exit
{{{sh
cd && umount -l /mnt/gentoo/dev{/shm,/pts,} && umount -R /mnt/gentoo &&
reboot
}}}
----
 - https://www.gentoo.org/get-started/
 - https://wiki.gentoo.org/wiki/Handbook:AMD64

=== distcc for emerge ===
 1. ssh root@calculate
     1. emerge --ask sys-devel/distcc
     2. vim /etc/conf.d/distccd
         {{{sh
         # add some like this:
         DISTCCD_OPTS="--port 3632 -N 15
         --log-level notice --log-file /var/log/distccd.log
         --allow 192.168.0.4 --allow 192.168.0.5"
         }}}
     3. rc-update add distccd default
     4. rc-service distccd start
 2. distcc-config --set-hosts "localhost,cpp,lzo calculate,cpp,lzo"
 3. vim /etc/portage/make.conf
     {{{conf
     # 1 remote hosts with 6 cores each = 6 cores remote
     # 1 local host with 8 cores = 8 cores local
     # total number of cores is 14, so N = 2*14+1 and M=8
     MAKEOPTS="-j29 -l8"
     FEATURES="distcc"
     }}}
----
 - https://wiki.gentoo.org/wiki/Distcc

=== can't ping under regular user (ping: socket: Operation not permitted) ===
{{{sh
emerge -C net-misc/iputils
emerge net-misc/iputils
}}}

=== write iso image of Windows to usb flash ===
`woeusb --device Win10_1909_Russian_x64.iso /dev/sdc`

=== set hostname ===
{{{sh
vim /etc/{conf.d/hostname,hosts}
hostname <hostname>
}}}

=== usage only needed network interface (ex. wired only) ===
{{{sh
vim /etc/conf.d/net
    config_enp2s0="dhcp"
cd /etc/init.d
ln -s net.lo net.enp2s0
rc-update add net.enp2s0 default
}}}

=== making bootable gentoo LiveUSB ===
{{{sh
emerge --ask sys-fs/dosfstools sys-boot/syslinux
cfdisk /dev/sdb
    gpt, 1G linux fs
mkfs.fat -F 16 /dev/sdb1
dd if=/usr/share/syslinux/mbr.bin of=/dev/sdb
mkdir -p /mnt/{iso,usb}
mount -o loop,ro -t iso9660 /path/to/isofile.iso /mnt/iso
mount -t vfat /dev/sdb1 /mnt/usb

# Copying and moving files:
cp -r /mnt/iso/* /mnt/usb
mv /mnt/usb/isolinux/* /mnt/usb
mv /mnt/usb/isolinux.cfg /mnt/usb/syslinux.cfg
rm -rf /mnt/usb/isolinux*
mv /mnt/usb/memtest86 /mnt/usb/memtest

sed -i \
    -e "s:cdroot:cdroot slowusb:" \
    -e "s:kernel memtest86:kernel memtest:" /mnt/usb/syslinux.cfg
umount /mnt/{iso,usb}
syslinux /dev/sdb1 # install the syslinux bootloader on the USB drive
}}}
----
- https://wiki.gentoo.org/wiki/LiveUSB/Guide

=== masked by: ~amd64 keyword ===
{{{sh
echo 'ACCEPT_KEYWORDS="~amd64"' >> /etc/portage/make.conf
}}}

=== reset tvheadend password ===
*Will be reset all settings besides password*
{{{sh
/etc/init.d/tvheadend stop
rm -rf /var/lib/tvheadend
/etc/init.d/tvheadend start
}}}

=== enable wake on lan ===
{{{sh
emerge --ask sys-apps/ethtool

# Checking and set current WOL status
#   d - disable
#   g - wake of MagicPackettm
ethtool enp4s0 | grep -i wake
    Supports Wake-on: pumbg
    Wake-on: d
ethtool -s enp4s0 wol g

vim /etc/conf.d/net
    ethtool_change_enp4s0="wol g"
cd /etc/init.d; ln -s net.lo net.enp4s0
rc-update add net.enp4s0 default
openrc
}}}
----
- https://wiki.gentoo.org/wiki/Power_management/Ethernet
- https://wiki.gentoo.org/wiki/Handbook:X86/Networking/Introduction

=== remove package ===
{{{sh
emerge --deselect dev-python/six
emerge --depclean -vp
emerge --ask --verbose --depclean dev-python/six
}}}
----
- https://wiki.gentoo.org/wiki/Gentoo_Cheat_Sheet#Package_removal

=== qemu ===
{{{sh
echo "app-emulation/qemu usb" >> /etc/portage/package.use
emerge -a app-emulation/qemu sys-apps/usbutils
usermod -aG kvm usb user1

export DISK=ubuntu-18.qcow2
qemu-system-x86_64 \
    -cpu host -enable-kvm -machine accel=kvm \
    -smp 4,sockets=1,cores=2,threads=2 \
    -m 4G \
    -drive file=$DISK,if=virtio \
    -net user,hostfwd=tcp::2222-:22 -net nic \
    -display default,show-cursor=on -vga virtio \
    -usb -device usb-tablet \
    -usb -device usb-ehci -device usb-host,vendorid=0x0572,productid=0xc68a
}}}
==== pci-passthrough ====
{{{sh
lscpu | grep -E "vmx|svm" # VT-x or AMD-V must be supported by the processor
# Go into BIOS (EFI) settings and turn on VT-d and IOMMU support
# Note: Some EFI doesn't have IOMMU configuration settings
vim /etc/default/grub
    GRUB_CMDLINE_LINUX="iommu=pt intel_iommu=on pcie_acs_override=downstream,multifunction"
grub-mkconfig -o /boot/grub/grub.cfg
reboot

dmesg | grep 'IOMMU enabled'
for d in /sys/kernel/iommu_groups/*/devices/*; do
    n=${d#*/iommu_groups/*}; n=${n%%/*}
    printf 'IOMMU Group %s ' "$n"
    lspci -nns "${d##*/}"
done # In IOMMU group 13 wireless networking controller only - it's fine
lspci -nn | grep Wireless
    03:00.0 Network controller [0280]: Qualcomm Atheros AR9485 Wireless Network Adapter [168c:0032] (rev 01)
vim /etc/modprobe.d/vfio.conf
    options vfio-pci ids=168c:0032
reboot

echo 0000:03:00.0 > /sys/bus/pci/devices/0000\:03\:00.0/driver/unbind
modprobe vfio-pci

export DISK=ubuntu-18.qcow2
qemu-system-x86_64 \
    -cpu host -enable-kvm -machine accel=kvm \
    -smp 4,sockets=1,cores=2,threads=2 \
    -m 4G \
    -drive file=$DISK,if=virtio \
    -net user,hostfwd=tcp::2222-:22 -net nic \
    -display default,show-cursor=on -vga virtio \
    -usb -device usb-tablet \
    -device vfio-pci,host=03:00.0
}}}
----
- https://wiki.gentoo.org/wiki/GPU_passthrough_with_libvirt_qemu_kvm
- https://davidyat.es/2016/09/08/gpu-passthrough/
- https://www.kernel.org/doc/Documentation/vfio.txt
